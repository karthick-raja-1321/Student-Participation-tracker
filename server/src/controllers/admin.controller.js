const User = require('../models/User');
const logger = require('../config/logger');
const { sendAccountCredentials } = require('../services/email.service');

// @desc    Reset user password (SUPER_ADMIN only)
// @route   POST /api/admin/reset-password/:userId
// @access  Private (SUPER_ADMIN)
exports.resetUserPassword = async (req, res, next) => {
  try {
    const { userId } = req.params;
    const { newPassword } = req.body;

    if (!newPassword || newPassword.length < 6) {
      return res.status(400).json({
        status: 'error',
        message: 'Please provide a valid password (minimum 6 characters)'
      });
    }

    const user = await User.findById(userId);

    if (!user) {
      return res.status(404).json({
        status: 'error',
        message: 'User not found'
      });
    }

    // Update password
    user.password = newPassword;
    await user.save();

    logger.info(`Password reset by admin for user: ${user.email}`);

    // Send new credentials email
    try {
      await sendAccountCredentials(
        user.email,
        user.firstName,
        user.email,
        newPassword
      );
    } catch (emailError) {
      logger.error(`Failed to send password reset email: ${emailError.message}`);
    }

    res.json({
      status: 'success',
      message: 'Password reset successfully',
      data: {
        email: user.email,
        newPassword
      }
    });
  } catch (error) {
    next(error);
  }
};

// @desc    Generate random password for user
// @route   POST /api/admin/generate-password/:userId
// @access  Private (SUPER_ADMIN)
exports.generatePassword = async (req, res, next) => {
  try {
    const { userId } = req.params;

    const user = await User.findById(userId);

    if (!user) {
      return res.status(404).json({
        status: 'error',
        message: 'User not found'
      });
    }

    // Generate random password
    const newPassword = Math.random().toString(36).slice(-8) + 
                       Math.random().toString(36).slice(-8).toUpperCase() + '123';

    user.password = newPassword;
    await user.save();

    logger.info(`Password generated by admin for user: ${user.email}`);

    // Send new credentials email
    try {
      await sendAccountCredentials(
        user.email,
        user.firstName,
        user.email,
        newPassword
      );
    } catch (emailError) {
      logger.error(`Failed to send password email: ${emailError.message}`);
    }

    res.json({
      status: 'success',
      message: 'Password generated successfully',
      data: {
        email: user.email,
        newPassword
      }
    });
  } catch (error) {
    next(error);
  }
};
